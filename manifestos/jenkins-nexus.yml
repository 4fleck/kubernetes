
apiVersion: v1
kind: Namespace
metadata:
  name: jnk

---

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: minimal-ingress
  namespace: jnk
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/backend-protocol: HTTP
spec:
  rules:
    - host: localhost
      http:
        paths:
        - path: /jenkins
          pathType: Prefix
          backend:
            service:
              name: jenkins-service
              port:
                number: 8080
        - path: /nexus
          pathType: Prefix
          backend:
            service:
              name: nexus-sevice
              port:
                number: 8081

# apiVersion: networking.k8s.io/v1
# kind: Ingress
# metadata:
#   name: minimal-ingress
#   namespace: jnk
#   annotations:
#     nginx.ingress.kubernetes.io/backend-protocol: HTTP
# spec:
#   ingressClassName: nginx
#   rules:
#   - host: admin.jenkins
#     http:
#       paths:
#       - path: /
#         pathType: Prefix
#         backend:
#             service:
#               name: jenkins-service
#               port:
#                 number: 8080
#   - host: admin.nexus
#     http:
#       paths:
#       - path: /
#         pathType: Prefix
#         backend:
#             service:
#               name: nexus-sevice
#               port:
#                 number: 8081

---

apiVersion: v1
kind: Service
metadata: 
  name: jenkins-service
  namespace: jnk
spec:
  selector: 
    app: jenkins
  ports: 
    - protocol: TCP
      name: http-port
      port: 8080
      targetPort: 8080
    - protocol: TCP
      name: jnlp-port
      port: 50000
      targetPort: 50000
  

---

apiVersion: v1
kind: Service
metadata: 
  name: nexus-sevice
  namespace: jnk
spec:
  selector: 
    app: sonatype-nexus
  ports: 
    - protocol: TCP
      name: nexus-port1
      port: 8081
      targetPort: 8081
    - protocol: TCP
      name: nexus-port3
      port: 8083
      targetPort: 8083

---

apiVersion: apps/v1
kind: Deployment
metadata:
  name: jenkins
  namespace: jnk
spec:
  replicas: 2
  selector:
    matchLabels:
      app: jenkins
  template:
    metadata:
      labels:
        app: jenkins
    spec:
      containers:
        - name: jenkins
          image: jenkins/jenkins:lts
          env:
            - name: JAVA_OPTS
              value: -Djenkins.install.runSetupWizard=false
          ports:
            - name: http-port
              containerPort: 8080
            - name: jnlp-port
              containerPort: 50000
          volumeMounts:
            - name: jenkins-home
              mountPath: /var/jenkins_home
      volumes:
        - name: jenkins-home
          emptyDir: {}

---

apiVersion: apps/v1
kind: Deployment
metadata:
  name: nexus
  namespace: jnk
spec:
  replicas: 1
  selector:
    matchLabels:
      app: sonatype-nexus
  template:
    metadata:
      labels:
        app: sonatype-nexus
    spec:
      containers:
        - name: nexus
          image: sonatype/nexus3
          ports:
            - name: nexus-port1
              containerPort: 8081
            - name: nexus-port3
              containerPort: 8083
          volumeMounts:
            - name: nexus-data
              mountPath: /nexus-data
      volumes:
        - name: nexus-data
          emptyDir: {}
